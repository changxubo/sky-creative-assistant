.tag_image:
  image: cnharbor.amway.com.cn/lightai/yq:3.3.4
  variables:
    IMAGE_URL: "${DOCKER_REGISTRY}/${DOCKER_PROJECT}/${IMAGE_NAME}:${CI_BUILD_REF_NAME}" 
  stage: tag_image
  script:
    - yq --version
    - yq w -i ${APP_YAML} 'spec.templates.(name==main).container.image' "$IMAGE_URL"-$(date -d "$IMAGE_TAG_FLAG" +%s)
    - yq -P r ${APP_YAML}
  artifacts:
    paths:
      - ${APP_YAML}
